style.
  .utterances {
    max-width: 100%;
  }
script(src="https://utteranc.es/client.js"
  repo=theme.utterances.repo
  issue-term=theme.utterances['issue-term']
  label=theme.utterances.label
  theme=theme.utterances.theme
  crossorigin="anonymous"
  async)

// keep utterances theme in sync with site light/dark mode
script.
  (function() {
    const UTTERANCES_ORIGIN = 'https://utteranc.es';

    function setUtterancesTheme() {
      const iframe = document.querySelector('iframe.utterances-frame');
      if (!iframe || !iframe.contentWindow) return;

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode = (window.CONFIG && window.CONFIG.mode) || 'light';
      const isDark = document.documentElement.classList.contains('dark')
        || mode === 'dark'
        || ((mode === 'auto' || mode === 'time') && prefersDark);

      const theme = isDark ? 'github-dark' : 'github-light';

      iframe.contentWindow.postMessage({ type: 'set-theme', theme }, UTTERANCES_ORIGIN);
    }

    // initial sync after utterances loads
    window.addEventListener('message', (event) => {
      if (event.origin !== UTTERANCES_ORIGIN) return;
      if (event.data && event.data.type === 'ready') {
        setUtterancesTheme();
        // re-check shortly after to catch mode class changes (auto/time)
        setTimeout(setUtterancesTheme, 200);
      }
    });

    // sync on theme toggle button click
    document.addEventListener('click', (evt) => {
      if (evt.target.closest('#toggle-mode-btn')) {
        // give darken a tick to toggle the class, then sync
        setTimeout(setUtterancesTheme, 50);
      }
    });

    // sync when the html dark class changes (covers auto/time mode)
    const observer = new MutationObserver(setUtterancesTheme);
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
  })();
